<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>美国手机号码手机号码筛重检测工具v2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3B82F6',
                        secondary: '#10B981',
                        danger: '#EF4444',
                        neutral: '#6B7280'
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .tab-active {
                @apply border-b-2 border-primary text-primary;
            }
            .drop-active {
                @apply border-primary-primary bg-blue-50;
            }
        }
    </style>
</head>
<body class="bg-gray-50 font-sans text-gray-800">
    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <!-- 头部 -->
        <header class="mb-8 text-center">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-800 mb-2">美国手机号码<think>筛重检测工具v2</h1>
            <p class="text-gray-600">支持数据存储的手机号码处理工具</p>
        </header>

        <!-- 授权区域 -->
        <section id="authSection" class="mb-8 bg-white p-4 rounded-lg shadow-sm">
            <div class="flex flex-col md:flex-row items-center justify-between">
                <div>
                    <h3 class="font-semibold flex items-center">
                        <i class="fa fa-github text-gray-800 mr-2"></i>
                        数据存储授权
                    </h3>
                    <p class="text-sm text-gray-600 mt-1">连接GitHub以保存和加载历史记录</p>
                </div>
                <div class="mt-4 md:mt-0 flex items-center w-full md:w-auto">
                    <input type="password" id="githubToken" placeholder="GitHub</think> Personal Access Token" 
                           class="px-3 py-2 border border-gray-300 rounded-l-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary text-sm w-full md:w-64">
                    <button id="verifyTokenBtn" class="bg-primary hover:bg-primary/90 text-white px-4 py-2 rounded-r-lg text-sm transition-colors">
                        验证
                    </button>
                </div>
            </div>
            <div id="tokenStatus" class="mt-2 text-sm hidden"></div>
            
            <!-- GitHub Token申请教程（可折叠） -->
            <div class="mt-3">
                <button id="tokenHelpToggle" class="text-primary text-sm flex items-center focus:outline-none">
                    <i class="fa fa-question-circle mr-1"></i> 如何获取GitHub Personal Access Token？
                    <i class="fa fa-chevron-down ml-1 text-xs transition-transform duration-200"></i>
                </button>
                
                <div id="tokenHelpContent" class="mt-3 text-sm bg-gray-50 p-4 rounded-lg hidden">
                    <h4 class="font-medium mb-3 text-gray-800">什么是Personal Access Token？</h4>
                    <p class="mb-3 text-gray-700">
                        Personal Access Token（个人访问令牌）是GitHub提供的一种安全验证方式，
                        允许本工具访问问您的GitHub仓库以存储和加载处理记录。令牌仅存储在您的浏览器中，
                        不会上传传到任何服务器。
                    </p>
                    
                    <h4 class="font-medium mb-3 text-gray-800">申请步骤（带repo权限）：</h4>
                    <ol class="list-decimal pl-5 space-y-4 mb-4">
                        <li>
                            <p class="mb-2"><strong>1. 登录GitHub并进入设置</strong></p>
                            <p>点击右上角头像，在下拉菜单中选择 <strong>Settings</strong>（设置）。</p>
                            <div class="mt-2 bg-white p-2 roundednded border border-gray-200">
                                <img src="https://picsum.photos/id/180/600/300" alt="GitHub设置入口" class="rounded w-full max-w-md">
                            </div>
                        </li>
                        <li>
                            <p class="mb-2"><strong>2. 进入开发者设置</strong></p>
                            <p>在左侧菜单底部，选择 <strong>Developer settings</strong>（开发者发者设置）。</p>
                        </li>
                        <li>
                            <p class="mb-2"><strong>3. 选择个人访问令牌</strong></p>
                            <p>在左侧菜单中选择 <strong>Personal access tokenss</strong>，然后点击 <strong>Tokens (classic)</strong>。</p>
                        </li>
                        <li>
                            <p class="mb-2"><strong>4. 生成新令牌</strong></p>
                            <p>点击右上角的 <strong>Generate new token</strong>，然后选择 <strong>Generate new token (classic)</strong>。</p>
                        </li>
                        <li>
                            <p class="mb-2"><strong>5. 配置令牌</strong></p>
                            <ul class="list-disc pl-5 space-y-1 mb-2">
                                <li>在 <strong>Note</strong> 字段中输入令牌名称（例如："US Phone Validator"）</li>
                                <li>设置 <strong>Expiration</strong>（有效期），建议选择30天</li>
                                <li>在 <strong>Select scopes</strong> 中，<strong>必须勾选</strong> <code>repo</code> 权限（展开后全选子项）</li>
                            </ul>
                            <div class="mt-2 bg-white p-2 rounded border border-gray-200">
                                <img src="https://picsum.photos/id/0/600/300" alt="GitHub令牌权限设置" class="rounded w-full max-w-md">
                            </div>
                        </li>
                        <li>
                            <p class="mb-2"><strong>6. 生成并保存令牌</strong></p>
                            <p>点击页面底部的 <strong>Generate token</strong> 按钮。生成后，<strong>立即复制令牌</strong>（仅显示一次）并妥善善保存。</p>
                        </li>
                    </ol>
                    
                    <h4 class="font-medium mb-2 text-gray-800">安全提示：</h4>
                    <ul class="list-disc pl-5 space-y-1 text-gray-700 text-sm">
                        <li>不要与他人共享您的令牌，它等同于您的账号密码</li>
                        <li>定期更换令牌（建议每月一次）以提高安全性</li>
                        <li>如果怀疑令牌泄露，可在GitHub令牌管理页面吊销该令牌</li>
                        <li>令牌仅存储在您的本地浏览器中，本工具不会收集或上传您的令牌</li>
                    </ul>
                </div>
            </div>
        </section>

        <!-- 主要内容区 -->
        <main>
            <!-- 上传区域 -->
            <section class="mb-8">
                <div id="dropZone" class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center transition-all duration-300">
                    <i class="fa fa-cloud-upload text-5xl text-gray-400 mb-4"></i>
                    <p class="text-gray-600 mb-4">拖放TXT或CSV文件到此处，或</p>
                    <label for="fileInput" class="inline-block bg-primary hover:bg-primary/90 text-white font-medium py-2 px-6 rounded-lg cursor-pointer transition-all duration-200">
                        <i class="fa fa-file-text-o mr-2"></i>选择文件
                    </label>
                    <input type="file" id="fileInput" accept=".txt,.csv" class="hidden">
                    <p class="text-sm text-gray-500 mt-4">支持格式：每行一个号码，或CSV格式。示例：(123) 456-7890、123-456-7890、1234567890</p>
                </div>

                <!-- 处理选项 -->
                <div id="optionsSection" class="mt-6 bg-white p-4 roundednded-lg shadow-sm hidden">
                    <h3 class="font-semibold mb-3">处理选项</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="flex items-center">
                            <input type="checkbox" id="verifyValidity" class="mr-2 h-4 w-4 text-primary" checked>
                            <label for="verifyValidity">验证号码真实性（需联网）</label>
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" id="detectCarrier" class="mr-2 h-4 w-4 text-primary" checked>
                            <label for="detectCarrier">检测运营商信息</label>
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" id="detectLineType" class="mr-2 h-4 w-4 text-primary" checked>
                            <label for="detectLineType">检测线路类型（手机/座机/VOIP）</label>
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" id="excludeVoip" class="mr-2 h-4 w-4 text-primary">
                            <label for="excludeVoip">排除VOIP号码</label>
                        </div>
                    </div>
                    <div class="mt-4 flex items-center">
                        <input type="text" id="saveName" placeholder="为本次处理命名（可选）" 
                               class="px-3 py-2 border border-gray-300 rounded-l-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary text-sm flex-grow">
                        <button id="processBtn" class="bg-primary hover:bg-primary/90 text-white font-medium py-2 px-6 rounded-r-lg transition-all duration-200">
                            <i class="fa fa-cog mr-2"></i>开始处理
                        </button>
                    </div>
                </div>
            </section>

            <!-- 进度条 -->
            <section id="progressSection" class="mb-8 hidden">
                <div class="bg-white p-4 rounded-lg shadow-sm">
                    <h3 class="font-semibold mb-2">处理进度</h3>
                    <div class="w-full bg-gray-200 rounded-full h-2.5 mb-2">
                        <div id="progressBar" class="bg-primary h-2.5 rounded-full transition-all duration-300" style="width: 0%"></div>
                    </div>
                    <p id="progressText" class="text-sm text-gray-600">准备中...</p>
                </div>
            </section>

            <!-- 历史记录 -->
            <section id="historySection" class="mb-8 hidden">
                <div class="bg-white p-4 rounded-lg shadow-sm">
                    <h3 class="font-semibold mb-3 flex items-center">
                        <i class="fa fa-history text-gray-600 mr-2"></i>
                        历史记录
                    </h3>
                    <div id="historyList" class="space-y-2 max-h-40 overflow-y-auto">
                        <!-- 历史记录将通过JS动态填充 -->
                        <p class="text-gray-500 text-sm italic">暂无历史记录</p>
                    </div>
                </div>
            </section>

            <!-- 统计结果 -->
            <section id="statsSection" class="mb-8 hidden">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white p-4 rounded-lg shadow-sm">
                        <h3 class="font-semibold mb-3">号码状态分布</h3>
                        <div class="h-64">
                            <canvas id="statusChart"></canvas>
                        </div>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow-sm">
                        <h3 class="font-semibold mb-3">号码类型分布</h3>
                        <div class="h-64">
                            <canvas id="typeChart"></canvas>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 结果标签页 -->
            <section id="resultsSection" class="mb-8 hidden">
                <div class="bg-white rounded-lg shadow-sm overflow-hidden">
                    <!-- 标签页导航 -->
                    <div class="flex border-b">
                        <button class="tab-btn tab-active px-6 py-3 font-medium text-left" data-tab="unique">
                            <i class="fa fa-check-circle text-secondary mr-2"></i>有效号码
                            <span id="uniqueCount" class="ml-1 bg-secondary/10 text-secondary text-xs px-2 py-1 rounded-full">0</span>
                        </button>
                        <button class="tab-btn px-6 py-3 font-medium text-left text-gray-600" data-tab="duplicates">
                            <i class="fa fa-exclamation-triangle text-amber-500 mr-2"></i>重复号码
                            <span id="duplicateCount" class="ml-1 bg-amber-500/10 text-amber-500 text-xs px-2 py-1 rounded-full">0</span>
                        </button>
                        <button class="tab-btn px-6 py-3 font-medium text-left text-gray-600" data-tab="invalid">
                            <i class="fa fa-times-circle text-danger mr-2"></i>无效号码
                            <span id="invalidCount" class="ml-1 bg-danger/10 text-danger text-xs px-2 py-1 rounded-full">0</span>
                        </button>
                    </div>

                    <!-- 标签页内容 -->
                    <div class="p-4">
                        <!-- 有效号码 -->
                        <div id="uniqueTab" class="tab-content">
                            <div class="flex justify-between items-center mb-4">
                                <p class="text-gray-600">已去重且验证有效的号码</p>
                                <button id="exportUniqueBtn" class="text-primary hover:text-primary/80 text-sm font-medium">
                                    <i class="fa fa-download mr-1"></i>导出
                                </button>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead>
                                        <tr>
                                            <th class="px-4 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">原始号码</th>
                                            <th class="px-4 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">标准化号码</th>
                                            <th class="px-4 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">运营商</th>
                                            <th class="px-4 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">类型</th>
                                        </tr>
                                    </thead>
                                    <tbody id="uniqueTableBody" class="bg-white divide-y divide-gray-200">
                                        <!-- 结果将通过JS动态填充 -->
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- 重复号码 -->
                        <div id="duplicatesTab" class="tab-content hidden">
                            <div class="flex justify-between items-center mb-4">
                                <p class="text-gray-600">检测到的重复号码</p>
                                <button id="exportDuplicatesBtn" class="text-primary hover:text-primary/80 text-sm font-medium">
                                    <i class="fa fa-download mr-1"></i>导出
                                </button>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead>
                                        <tr>
                                            <th class="px-4 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">原始号码</th>
                                            <th class="px-4 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">标准化号码</th>
                                            <th class="px-4 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">重复次数</th>
                                        </tr>
                                    </thead>
                                    <tbody id="duplicatesTableBody" class="bg-white divide-y divide-gray-200">
                                        <!-- 结果将通过JS动态填充 -->
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- 无效号码 -->
                        <div id="invalidTab" class="tab-content hidden">
                            <div class="flex justify-between items-center mb-4">
                                <p class="text-gray-600">格式错误或无效的号码</p>
                                <button id="exportInvalidBtn" class="text-primary hover:text-primary/80 text-sm font-medium">
                                    <i class="fa fa-download mr-1"></i>导出
                                </button>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead>
                                        <tr>
                                            <th class="px-4 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">原始号码</th>
                                            <th class="px-4 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">原因</th>
                                        </tr>
                                    </thead>
                                    <tbody id="invalidTableBody" class="bg-white divide-y divide-gray-200">
                                        <!-- 结果将通过JS动态填充 -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </main>

        <!-- 页脚 -->
        <footer class="mt-12 text-center text-gray-500 text-sm">
            <p>© 2023 美国手机号码筛重检测工具v2 | <a href="#" class="hover:text-primary">隐私政策</a> | <a href="#" class="hover:text-primary">使用条款</a></p>
            <p class="mt-2">数据存储在您的GitHub仓库中，需授权访问</p>
        </footer>
    </div>

    <script>
        // 已根据你的信息配置GitHub参数
        const GITHUB_CONFIG = {
            owner: 'enolan8',        // 你的GitHub用户名
            repo: 'byhmk',           // 你的仓库名
            dataFile: 'data/history.json'  // 数据存储路径
        };

        // 全局变量
        let processingResults = {
            unique: [],
            duplicates: [],
            invalid: [],
            stats: {
                total: 0,
                unique: 0,
                duplicates: 0,
                invalid: 0,
                types: {
                    mobile: 0,
                    landline: 0,
                    voip: 0,
                    other: 0
                }
            },
            name: '',
            timestamp: null
        };
        
        let githubToken = localStorage.getItem('githubToken') || '';
        let isTokenValid = false;
        let historyRecords = [];

        // DOM元素
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const optionsSection = document.getElementById('optionsSection');
        const processBtn = document.getElementById('processBtn');
        const progressSection = document.getElementById('progressSection');
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');
        const statsSection = document.getElementById('statsSection');
        const resultsSection = document.getElementById('resultsSection');
        const tabBtns = document.querySelectorAll('.tab-btn');
        const githubTokenInput = document.getElementById('githubToken');
        const verifyTokenBtn = document.getElementById('verifyTokenBtn');
        const tokenStatus = document.getElementById('tokenStatus');
        const tokenHelpToggle = document.getElementById('tokenHelpToggle');
        const tokenHelpContent = document.getElementById('tokenHelpContent');
        const historySection = document.getElementById('historySection');
        const historyList = document.getElementById('historyList');
        const saveNameInput = document.getElementById('saveName');
        
        // 初始化图表
        let statusChart, typeChart;

        // 初始化
        document.addEventListener('DOMContentLoaded', () => {
            // 填充保存的token
            if (githubToken) {
                githubTokenInput.value = githubToken;
                verifyToken();
            }
            
            // 令牌帮助折叠面板
            tokenHelpToggle.addEventListener('click', () => {
                tokenHelpContent.classList.toggle('hidden');
                const icon = tokenHelpToggle.querySelector('.fa-chevron-down');
                icon.classList.toggle('rotate-180');
            });
            
            // 验证token按钮
            verifyTokenBtn.addEventListener('click', verifyToken);
            
            // 加载历史记录
            loadHistory();
        });

        // 验证GitHub Token
        async function verifyToken() {
            const token = githubTokenInput.value.trim();
            if (!token) {
                showTokenStatus('请输入GitHub Personal Access Token', 'error');
                isTokenValid = false;
                return;
            }
            
            try {
                // 尝试调用GitHub API验证token
                const response = await fetch('https://api.github.com/user', {
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (response.ok) {
                    const user = await response.json();
                    githubToken = token;
                    localStorage.setItem('githubToken', token);
                    isTokenValid = true;
                    showTokenStatus(`已验证，登录用户: ${user.login}`, 'success');
                    
                    // 显示历史记录区域
                    historySection.classList.remove('hidden');
                    // 加载历史记录
                    loadHistory();
                } else {
                    showTokenStatus('Token无效或权限不足，请检查并重新输入', 'error');
                    isTokenValid = false;
                }
            } catch (error) {
                showTokenStatus('验证失败，请检查网络连接', 'error');
                isTokenValid = false;
                console.error('Token验证错误:', error);
            }
        }

        // 显示Token状态
        function showTokenStatus(message, type) {
            tokenStatus.textContent = message;
            tokenStatus.classList.remove('hidden', 'text-green-600', 'text-red-600');
            
            if (type === 'success') {
                tokenStatus.classList.add('text-green-600');
            } else {
                tokenStatus.classList.add('text-red-600');
            }
        }

        // 加载历史记录
        async function loadHistory() {
            if (!isTokenValid) return;
            
            try {
                // 检查数据文件是否存在
                const response = await fetch(`https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${GITHUB_CONFIG.dataFile}`, {
                    headers: {
                        'Authorization': `token ${githubToken}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    // 解码base64内容
                    const content = atob(data.content);
                    historyRecords = JSON.parse(content);
                    renderHistoryList();
                } else if (response.status === 404) {
                    // 文件不存在，初始化空数组
                    historyRecords = [];
                    renderHistoryList();
                } else {
                    throw new Error(`HTTP错误: ${response.status}`);
                }
            } catch (error) {
                console.error('加载历史记录失败:', error);
                historyList.innerHTML = `<p class="text-red-500 text-sm">加载历史记录失败: ${error.message}</p>`;
            }
        }

        // 渲染历史记录列表
        function renderHistoryList() {
            if (historyRecords.length === 0) {
                historyList.innerHTML = '<p class="text-gray-500 text-sm italic">暂无历史记录</p>';
                return;
            }
            
            // 按时间倒序排列
            historyRecords.sort((a, b) => b.timestamp - a.timestamp);
            
            let html = '';
            historyRecords.forEach((record, index) => {
                const date = new Date(record.timestamp);
                html += `
                <div class="flex items-center justify-between p-2 border border-gray-100 rounded-lg hover:bg-gray-50">
                    <div>
                        <p class="font-medium text-sm">${record.name || `处理记录 ${index + 1}`}</p>
                        <p class="text-xs text-gray-500">${date.toLocaleString()} · 共${record.stats.total}个号码</p>
                    </div>
                    <div class="flex space-x-1">
                        <button class="text-primary hover:text-primary/80 text-xs" onclick="loadRecord(${index})">
                            <i class="fa fa-eye mr-1"></i>查看
                        </button>
                        <button class="text-red-500 hover:text-red-600 text-xs" onclick="deleteRecord(${index})">
                            <i class="fa fa-trash"></i>
                        </button>
                    </div>
                </div>
                `;
            });
            
            historyList.innerHTML = html;
        }

        // 保存记录到GitHub
        async function saveRecord() {
            if (!isTokenValid) {
                alert('请先验证GitHub Token以保存记录');
                return;
            }
            
            // 添加元数据
            processingResults.timestamp = Date.now();
            processingResults.name = saveNameInput.value.trim() || `处理记录 ${new Date().toLocaleString()}`;
            
            try {
                // 准备要保存的数据
                const newHistory = [...historyRecords, processingResults];
                
                // 检查文件是否存在（获取sha值用于更新）
                let sha = null;
                const checkResponse = await fetch(`https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${GITHUB_CONFIG.dataFile}`, {
                    headers: {
                        'Authorization': `token ${githubToken}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (checkResponse.ok) {
                    const data = await checkResponse.json();
                    sha = data.sha;
                }
                
                // 提交数据
                const response = await fetch(`https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${GITHUB_CONFIG.dataFile}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${githubToken}`,
                        'Content-Type': 'application/json',
                        'Accept': 'application/vnd.github.v3+json'
                    },
                    body: JSON.stringify({
                        message: `保存历史记录: ${processingResults.name}`,
                        content: btoa(JSON.stringify(newHistory, null, 2)),
                        sha: sha // 仅在更新现有文件时需要
                    })
                });
                
                if (response.ok) {
                    historyRecords = newHistory;
                    renderHistoryList();
                    return true;
                } else {
                    const error = await response.json();
                    throw new Error(error.message || '保存失败');
                }
            } catch (error) {
                console.error('保存记录失败:', error);
                alert(`保存记录失败: ${error.message}`);
                return false;
            }
        }

        // 加载历史记录
        function loadRecord(index) {
            const record = historyRecords[index];
            processingResults = { ...record };
            showResults();
        }

        // 删除历史记录
        async function deleteRecord(index) {
            if (!confirm('确定要删除这条记录吗？')) return;
            
            try {
                // 更新历史记录数组
                historyRecords.splice(index, 1);
                
                // 获取当前文件的sha
                const checkResponse = await fetch(`https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${GITHUB_CONFIG.dataFile}`, {
                    headers: {
                        'Authorization': `token ${githubToken}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (!checkResponse.ok) {
                    throw new Error('获取文件信息失败');
                }
                
                const data = await checkResponse.json();
                const sha = data.sha;
                
                // 如果删除后没有记录了，就删除文件
                let response;
                if (historyRecords.length === 0) {
                    response = await fetch(`https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${GITHUB_CONFIG.dataFile}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `token ${githubToken}`,
                            'Content-Type': 'application/json',
                            'Accept': 'application/vnd.github.v3+json'
                        },
                        body: JSON.stringify({
                            message: '删除所有历史记录',
                            sha: sha
                        })
                    });
                } else {
                    // 否则更新文件
                    response = await fetch(`https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${GITHUB_CONFIG.dataFile}`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `token ${githubToken}`,
                            'Content-Type': 'application/json',
                            'Accept': 'application/vnd.github.v3+json'
                        },
                        body: JSON.stringify({
                            message: '删除一条历史记录',
                            content: btoa(JSON.stringify(historyRecords, null, 2)),
                            sha: sha
                        })
                    });
                }
                
                if (response.ok) {
                    renderHistoryList();
                } else {
                    const error = await response.json();
                    throw new Error(error.message || '删除失败');
                }
            } catch (error) {
                console.error('删除记录失败:', error);
                alert(`删除记录失败: ${error.message}`);
            }
        }

        // 事件监听：文件拖放
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
            dropZone.addEventListener(eventName, highlight, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, unhighlight, false);
        });

        function highlight() {
            dropZone.classList.add('drop-active');
        }

        function unhighlight() {
            dropZone.classList.remove('drop-active');
        }

        // 处理文件 drop
        dropZone.addEventListener('drop', handleDrop, false);
        fileInput.addEventListener('change', handleFiles, false);

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            handleFiles({ target: { files } });
        }

        function handleFiles(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            // 显示处理选项
            optionsSection.classList.remove('hidden');
            
            // 读取文件内容
            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                // 存储文件内容到全局变量
                window.fileContent = content;
                // 显示文件信息
                document.querySelector('#optionsSection .text-sm.text-gray-600')?.remove();
                const fileInfo = document.createElement('p');
                fileInfo.className = 'text-sm text-gray-600 mt-2';
                fileInfo.textContent = `已加载文件: ${file.name} (预计号码数量: ${estimatePhoneCount(content)})`;
                optionsSection.appendChild(fileInfo);
            };
            reader.readAsText(file);
        }

        // 估算号码数量
        function estimatePhoneCount(content) {
            return content.split(/[\r\n,]+/).filter(line => line.trim().length > 5).length;
        }

        // 处理按钮点击
        processBtn.addEventListener('click', startProcessing);

        // 开始处理号码
        function startProcessing() {
            if (!window.fileContent) return;
            
            // 显示进度条
            progressSection.classList.remove('hidden');
            statsSection.classList.add('hidden');
            resultsSection.classList.add('hidden');
            progressBar.style.width = '0%';
            progressText.textContent = '正在解析号码...';
            
            // 解析号码
            const rawPhones = window.fileContent.split(/[\r\n,]+/)
                .map(line => line.trim())
                .filter(line => line.length > 0);
            
            // 初始化结果
            processingResults = {
                unique: [],
                duplicates: [],
                invalid: [],
                stats: {
                    total: rawPhones.length,
                    unique: 0,
                    duplicates: 0,
                    invalid: 0,
                    types: {
                        mobile: 0,
                        landline: 0,
                        voip: 0,
                        other: 0
                    }
                },
                name: saveNameInput.value.trim(),
                timestamp: null
            };
            
            // 格式化和去重
            setTimeout(() => processNormalization(rawPhones), 500);
        }

        // 格式化和去重处理
        function processNormalization(rawPhones) {
            const total = rawPhones.length;
            const normalizedMap = new Map(); // 存储标准化号码及其原始号码和出现次数
            
            // 第一步：格式化所有号码并检测基本格式有效性
            rawPhones.forEach((raw, index) => {
                // 更新进度
                const progress = Math.round(((index + 1) / total) * 30); // 前30%进度用于格式化
                progressBar.style.width = `${progress}%`;
                progressText.textContent = `正在格式化号码... (${index + 1}/${total})`;
                
                const result = normalizeAndValidateFormat(raw);
                if (!result.valid) {
                    processingResults.invalid.push({
                        original: raw,
                        reason: result.reason
                    });
                    return;
                }
                
                // 跟踪重复
                if (normalizedMap.has(result.normalized)) {
                    const entry = normalizedMap.get(result.normalized);
                    entry.count++;
                    processingResults.duplicates.push({
                        original: raw,
                        normalized: result.normalized,
                        count: entry.count
                    });
                } else {
                    normalizedMap.set(result.normalized, {
                        original: raw,
                        normalized: result.normalized,
                        count: 1
                    });
                }
            });
            
            // 更新统计
            processingResults.stats.invalid = processingResults.invalid.length;
            processingResults.stats.duplicates = processingResults.duplicates.length;
            
            // 准备验证的号码列表
            const uniqueToVerify = Array.from(normalizedMap.values())
                .map(entry => ({
                    original: entry.original,
                    normalized: entry.normalized
                }));
            
            processingResults.stats.unique = uniqueToVerify.length;
            
            // 下一步：验证号码真实性（如果启用）
            setTimeout(() => {
                if (document.getElementById('verifyValidity').checked) {
                    processVerification(uniqueToVerify);
                } else {
                    // 不验证，直接标记为有效
                    uniqueToVerify.forEach(phone => {
                        processingResults.unique.push({
                            ...phone,
                            valid: true,
                            carrier: '未检测',
                            line_type: '未检测'
                        });
                    });
                    progressBar.style.width = '100%';
                    progressText.textContent = '处理完成，正在保存记录...';
                    
                    // 保存记录（如果已授权）
                    setTimeout(async () => {
                        if (isTokenValid) {
                            await saveRecord();
                        }
                        showResults();
                    }, 500);
                }
            }, 500);
        }

        // 验证号码真实性（调用API）
        function processVerification(phonesToVerify) {
            const total = phonesToVerify.length;
            const verifyValidity = document.getElementById('verifyValidity').checked;
            const detectCarrier = document.getElementById('detectCarrier').checked;
            const detectLineType = document.getElementById('detectLineType').checked;
            const excludeVoip = document.getElementById('excludeVoip').checked;
            
            // 逐个验证（避免API请求限制）
            let completed = 0;
            
            phonesToVerify.forEach((phone, index) => {
                // 模拟API请求（实际项目中替换为真实API调用）
                setTimeout(async () => {
                    try {
                        // 注意：实际使用时，这里应该调用你的Serverless代理函数
                        // 示例：const response = await fetch('/.netlify/functions/verify', { ... })
                        
                        // 模拟API响应
                        const isVoip = Math.random() < 0.2; // 20%概率为VOIP
                        const lineType = isVoip ? 'voip' : 
                                          Math.random() < 0.7 ? 'mobile' : 'landline';
                        const carriers = ['Verizon', 'AT&T', 'T-Mobile', 'Sprint', 'Other'];
                        const carrier = carriers[Math.floor(Math.random() * carriers.length)];
                        
                        const result = {
                            valid: Math.random() > 0.1, // 90%概率有效
                            carrier: detectCarrier ? carrier : '未检测',
                            line_type: detectLineType ? lineType : '未检测'
                        };
                        
                        // 处理结果
                        if (result.valid && !(excludeVoip && result.line_type === 'voip')) {
                            processingResults.unique.push({
                                ...phone,
                                ...result
                            });
                            
                            // 更新类型统计
                            if (result.line_type === 'mobile') {
                                processingResults.stats.types.mobile++;
                            } else if (result.line_type === 'landline') {
                                processingResults.stats.types.landline++;
                            } else if (result.line_type === 'voip') {
                                processingResults.stats.types.voip++;
                            } else {
                                processingResults.stats.types.other++;
                            }
                        } else {
                            processingResults.invalid.push({
                                original: phone.original,
                                reason: result.valid ? '被排除的VOIP号码' : '无效号码'
                            });
                            processingResults.stats.invalid++;
                        }
                    } catch (error) {
                        console.error('验证失败:', error);
                        processingResults.invalid.push({
                            original: phone.original,
                            reason: '验证服务出错'
                        });
                        processingResults.stats.invalid++;
                    }
                    
                    // 更新进度
                    completed++;
                    const progress = 30 + Math.round((completed / total) * 70); // 后70%进度用于验证
                    progressBar.style.width = `${progress}%`;
                    progressText.textContent = `正在验证号码... (${completed}/${total})`;
                    
                    // 全部完成
                    if (completed === total) {
                        progressText.textContent = '处理完成，正在保存记录...';
                        
                        // 保存记录（如果已授权）
                        setTimeout(async () => {
                            if (isTokenValid) {
                                await saveRecord();
                            }
                            showResults();
                        }, 500);
                    }
                }, index * 300); // 每个请求间隔300ms，避免API限流
            });
        }

        // 显示处理结果
        function showResults() {
            // 更新计数
            document.getElementById('uniqueCount').textContent = processingResults.unique.length;
            document.getElementById('duplicateCount').textContent = processingResults.duplicates.length;
            document.getElementById('invalidCount').textContent = processingResults.invalid.length;
            
            // 填充表格
            fillTable('uniqueTableBody', processingResults.unique, 'unique');
            fillTable('duplicatesTableBody', processingResults.duplicates, 'duplicates');
            fillTable('invalidTableBody', processingResults.invalid, 'invalid');
            
            // 绘制图表
            drawCharts();
            
            // 显示结果区域
            statsSection.classList.remove('hidden');
            resultsSection.classList.remove('hidden');
            progressSection.classList.add('hidden');
        }

        // 填充表格数据
        function fillTable(tableId, data, type) {
            const tableBody = document.getElementById(tableId);
            tableBody.innerHTML = ''; // 清空
            
            if (data.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `<td colspan="${type === 'invalid' ? 2 : type === 'duplicates' ? 3 : 4}" class="px-4 py-8 text-center text-gray-500">
                    没有${type === 'unique' ? '有效' : type === 'duplicates' ? '重复' : '无效'}号码
                </td>`;
                tableBody.appendChild(row);
                return;
            }
            
            data.forEach(item => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                
                if (type === 'unique') {
                    row.innerHTML = `
                        <td class="px-4 py-3 whitespace-nowrap">${item.original}</td>
                        <td class="px-4 py-3 whitespace-nowrap">${formatPhone(item.normalized)}</td>
                        <td class="px-4 py-3 whitespace-nowrap">${item.carrier}</td>
                        <td class="px-4 py-3 whitespace-nowrap">
                            <span class="px-2 py-1 text-xs rounded-full ${
                                item.line_type === 'mobile' ? 'bg-green-100 text-green-800' :
                                item.line_type === 'landline' ? 'bg-blue-100 text-blue-800' :
                                item.line_type === 'voip' ? 'bg-purple-100 text-purple-800' :
                                'bg-gray-100 text-gray-800'
                            }">${
                                item.line_type === 'mobile' ? '手机' :
                                item.line_type === 'landline' ? '座机' :
                                item.line_type === 'voip' ? 'VOIP' : '其他'
                            }</span>
                        </td>
                    `;
                } else if (type === 'duplicates') {
                    row.innerHTML = `
                        <td class="px-4 py-3 whitespace-nowrap">${item.original}</td>
                        <td class="px-4 py-3 whitespace-nowrap">${formatPhone(item.normalized)}</td>
                        <td class="px-4 py-3 whitespace-nowrap">
                            <span class="px-2 py-1 text-xs rounded-full bg-amber-100 text-amber-800">
                                重复 ${item.count} 次
                            </span>
                        </td>
                    `;
                } else if (type === 'invalid') {
                    row.innerHTML = `
                        <td class="px-4 py-3 whitespace-nowrap">${item.original}</td>
                        <td class="px-4 py-3 whitespace-nowrap">${item.reason}</td>
                    `;
                }
                
                tableBody.appendChild(row);
            });
        }

        // 绘制统计图表
        function drawCharts() {
            // 状态分布图表
            const statusCtx = document.getElementById('statusChart').getContext('2d');
            if (statusChart) statusChart.destroy();
            
            statusChart = new Chart(statusCtx, {
                type: 'pie',
                data: {
                    labels: ['有效号码', '重复号码', '无效号码'],
                    datasets: [{
                        data: [
                            processingResults.unique.length,
                            processingResults.duplicates.length,
                            processingResults.invalid.length
                        ],
                        backgroundColor: [
                            '#10B981', // 绿色-有效
                            '#F59E0B', // 黄色-重复
                            '#EF4444'  // 红色-无效
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
            
            // 类型分布图表
            const typeCtx = document.getElementById('typeChart').getContext('2d');
            if (typeChart) typeChart.destroy();
            
            typeChart = new Chart(typeCtx, {
                type: 'doughnut',
                data: {
                    labels: ['手机', '座机', 'VOIP', '其他'],
                    datasets: [{
                        data: [
                            processingResults.stats.types.mobile,
                            processingResults.stats.types.landline,
                            processingResults.stats.types.voip,
                            processingResults.stats.types.other
                        ],
                        backgroundColor: [
                            '#10B981', // 绿色-手机
                            '#3B82F6', // 蓝色-座机
                            '#8B5CF6', // 紫色-VOIP
                            '#6B7280'  // 灰色-其他
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        // 标签页切换
        tabBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                // 移除所有标签的活跃状态
                tabBtns.forEach(b => b.classList.remove('tab-active', 'text-primary'));
                b.classList.add('text-gray-600');
                
                // 隐藏所有内容
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.add('hidden');
                });
                
                // 激活当前标签
                btn.classList.add('tab-active', 'text-primary');
                btn.classList.remove('text-gray-600');
                
                // 显示对应内容
                const tabId = btn.getAttribute('data-tab');
                document.getElementById(`${tabId}Tab`).classList.remove('hidden');
            });
        });

        // 导出功能
        document.getElementById('exportUniqueBtn').addEventListener('click', () => {
            exportResults(processingResults.unique, '有效号码');
        });
        
        document.getElementById('exportDuplicatesBtn').addEventListener('click', () => {
            exportResults(processingResults.duplicates, '重复号码');
        });
        
        document.getElementById('exportInvalidBtn').addEventListener('click', () => {
            exportResults(processingResults.invalid, '无效号码');
        });

        // 导出结果为CSV
        function exportResults(data, name) {
            if (data.length === 0) {
                alert(`没有可导出的${name}`);
                return;
            }
            
            let csvContent = '';
            
            // 添加表头
            if (data[0].normalized && data[0].carrier) {
                csvContent += '原始号码,标准化号码,运营商,类型\n';
            } else if (data[0].normalized) {
                csvContent += '原始号码,标准化号码,重复次数\n';
            } else {
                csvContent += '原始号码,原因\n';
            }
            
            // 添加数据行
            data.forEach(item => {
                if (item.normalized && item.carrier) {
                    const lineType = item.line_type === 'mobile' ? '手机' :
                                   item.line_type === 'landline' ? '座机' :
                                   item.line_type === 'voip' ? 'VOIP' : '其他';
                    csvContent += `"${escapeCsv(item.original)}","${item.normalized}","${item.carrier}","${lineType}"\n`;
                } else if (item.normalized) {
                    csvContent += `"${escapeCsv(item.original)}","${item.normalized}","${item.count}"\n`;
                } else {
                    csvContent += `"${escapeCsv(item.original)}","${item.reason}"\n`;
                }
            });
            
            // 创建并下载文件
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.setAttribute('href', url);
            a.setAttribute('download', `${name}-${new Date().toISOString().slice(0,10)}.csv`);
            a.style.visibility = 'hidden';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        // CSV转义
        function escapeCsv(value) {
            if (!value) return '';
            return value.replace(/"/g, '""');
        }

        // 格式化号码为易读形式 (123) 456-7890
        function formatPhone(phone) {
            if (!phone || phone.length !== 10) return phone;
            return `(${phone.slice(0,3)}) ${phone.slice(3,6)}-${phone.slice(6)}`;
        }

        // 标准化并验证号码格式
        function normalizeAndValidateFormat(phone) {
            // 去除所有非数字字符
            const digits = phone.replace(/\D/g, '');
            
            // 处理带国家码的情况（美国国家码为1）
            let normalized;
            if (digits.startsWith('1')) {
                if (digits.length === 11) {
                    normalized = digits.slice(1); // 保留后10位
                } else if (digits.length === 10) {
                    normalized = digits; // 已经是10位，可能误加了国家码
                } else {
                    return { valid: false, reason: '长度不符合美国号码规则' };
                }
            } else if (digits.length === 10) {
                normalized = digits;
            } else {
                return { valid: false, reason: '长度不符合美国号码规则' };
            }
            
            // 验证NPA（区号）：首位不能为0或1
            const npa = normalized.slice(0, 3);
            if (npa[0] === '0' || npa[0] === '1') {
                return { valid: false, reason: '无效的区号（首位不能为0或1）' };
            }
            
            // 验证NXX（中央办公室代码）：首位不能为0或1
            const nxx = normalized.slice(3, 6);
            if (nxx[0] === '0' || nxx[0] === '1') {
                return { valid: false, reason: '无效的中央办公室代码（首位不能为0或1）' };
            }
            
            return { valid: true, normalized };
        }

        // 暴露给全局的函数（用于历史记录操作）
        window.loadRecord = loadRecord;
        window.deleteRecord = deleteRecord;
    </script>
</body>
</html>
